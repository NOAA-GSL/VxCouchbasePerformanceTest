#!/usr/bin/env bash
source ./getopts.sh
read -d '' prologue << PEOF
This is a test of a query captured from a basic die-off plot from the metviewer at
http://137.75.129.120:8080/metviewer-mysql/servlet  - historical plot named 20200515_162720.
PEOF
mysql --defaults-file=my.cnf -vvv  mv_gfs_grid2obs_vsdb2 <<-'EOF' > "output/$0.tmp"
SELECT 
h.vx_mask, ld.fcst_init_beg, ld.fcst_valid_beg, ld.fcst_lead, h.model, h.fcst_lev, h.fcst_var, ld.oabar, ld.fabar, ld.ooabar, ld.foabar, ld.ffabar, ld.total
FROM stat_header h, line_data_sal1l2 ld
WHERE BINARY h.model IN ('GFS')
  AND BINARY h.fcst_lev IN ('P500')
  AND BINARY ld.fcst_valid_beg IN ('2019-01-01 00:00:00',
				   '2019-01-01 06:00:00',
				   '2019-01-01 12:00:00',
                                   '2019-01-01 18:00:00',
                                   '2019-01-02 00:00:00',
                                   '2019-01-02 06:00:00',
                                   '2019-01-02 12:00:00',
                                   '2019-01-02 18:00:00',
                                   '2019-01-03 00:00:00',
                                   '2019-01-03 06:00:00',
                                   '2019-01-03 12:00:00',
                                   '2019-01-03 18:00:00',
                                   '2019-01-04 00:00:00',
                                   '2019-01-04 06:00:00',
                                   '2019-01-04 12:00:00',
                                   '2019-01-04 18:00:00',
                                   '2019-01-05 00:00:00',
                                   '2019-01-05 06:00:00',
                                   '2019-01-05 12:00:00',
                                   '2019-01-05 18:00:00',
                                   '2019-01-06 00:00:00',
                                   '2019-01-06 06:00:00',
                                   '2019-01-06 12:00:00',
                                   '2019-01-06 18:00:00',
                                   '2019-01-07 00:00:00',
                                   '2019-01-07 06:00:00',
                                   '2019-01-07 12:00:00',
                                   '2019-01-07 18:00:00',
                                   '2019-01-08 00:00:00',
                                   '2019-01-08 06:00:00',
                                   '2019-01-08 12:00:00',
                                   '2019-01-08 18:00:00',
                                   '2019-01-09 00:00:00',
                                   '2019-01-09 06:00:00',
                                   '2019-01-09 12:00:00',
                                   '2019-01-09 18:00:00',
                                   '2019-01-10 00:00:00',
                                   '2019-01-10 06:00:00',
                                   '2019-01-10 12:00:00',
                                   '2019-01-10 18:00:00',
                                   '2019-01-11 00:00:00',
                                   '2019-01-11 06:00:00',
                                   '2019-01-11 12:00:00',
                                   '2019-01-11 18:00:00',
                                   '2019-01-12 00:00:00',
                                   '2019-01-12 06:00:00',
                                   '2019-01-12 12:00:00',
                                   '2019-01-12 18:00:00',
                                   '2019-01-13 00:00:00',
                                   '2019-01-13 06:00:00',
                                   '2019-01-13 12:00:00',
                                   '2019-01-13 18:00:00',
                                   '2019-01-14 00:00:00',
                                   '2019-01-14 06:00:00',
                                   '2019-01-14 12:00:00',
                                   '2019-01-14 18:00:00',
                                   '2019-01-15 00:00:00',
                                   '2019-01-15 06:00:00',
                                   '2019-01-15 12:00:00',
                                   '2019-01-15 18:00:00',
                                   '2019-01-16 00:00:00',
                                   '2019-01-16 06:00:00',
                                   '2019-01-16 12:00:00',
                                   '2019-01-16 18:00:00',
                                   '2019-01-17 00:00:00',
                                   '2019-01-17 06:00:00',
                                   '2019-01-17 12:00:00',
                                   '2019-01-17 18:00:00',
                                   '2019-01-18 00:00:00',
                                   '2019-01-18 06:00:00',
                                   '2019-01-18 12:00:00',
                                   '2019-01-18 18:00:00',
                                   '2019-01-19 00:00:00',
                                   '2019-01-19 06:00:00',
                                   '2019-01-19 12:00:00',
                                   '2019-01-19 18:00:00',
                                   '2019-01-20 00:00:00',
                                   '2019-01-20 06:00:00',
                                   '2019-01-20 12:00:00',
                                   '2019-01-20 18:00:00',
                                   '2019-01-21 00:00:00',
                                   '2019-01-21 06:00:00',
                                   '2019-01-21 12:00:00',
                                   '2019-01-21 18:00:00',
                                   '2019-01-22 00:00:00',
                                   '2019-01-22 06:00:00',
                                   '2019-01-22 12:00:00',
                                   '2019-01-22 18:00:00',
                                   '2019-01-23 00:00:00',
                                   '2019-01-23 06:00:00',
                                   '2019-01-24 00:00:00',
                                   '2019-01-24 06:00:00',
                                   '2019-01-24 12:00:00',
                                   '2019-01-24 18:00:00',
                                   '2019-01-25 00:00:00',
                                   '2019-01-25 06:00:00',
                                   '2019-01-25 12:00:00',
                                   '2019-01-25 18:00:00',
                                   '2019-01-26 00:00:00',
                                   '2019-01-26 06:00:00',
                                   '2019-01-26 12:00:00',
                                   '2019-01-26 18:00:00',
                                   '2019-01-27 00:00:00',
                                   '2019-01-27 06:00:00',
                                   '2019-01-27 12:00:00',
                                   '2019-01-27 18:00:00',
                                   '2019-01-28 00:00:00',
                                   '2019-01-28 06:00:00',
                                   '2019-01-28 12:00:00',
                                   '2019-01-28 18:00:00',
                                   '2019-01-29 00:00:00',
                                   '2019-01-29 06:00:00',
                                   '2019-01-29 12:00:00',
                                   '2019-01-29 18:00:00',
                                   '2019-01-30 00:00:00',
                                   '2019-01-30 06:00:00',
                                   '2019-01-30 12:00:00',
                                   '2019-01-30 18:00:00',
                                   '2019-01-31 00:00:00',
                                   '2019-01-31 06:00:00',
                                   '2019-01-31 12:00:00',
                                   '2019-01-31 18:00:00',
                                   '2019-02-01 00:00:00',
                                   '2019-02-01 06:00:00',
                                   '2019-02-01 12:00:00',
                                   '2019-02-01 18:00:00',
                                   '2019-02-02 00:00:00',
                                   '2019-02-02 06:00:00',
                                   '2019-02-02 12:00:00',
                                   '2019-02-02 18:00:00',
                                   '2019-02-03 00:00:00',
                                   '2019-02-03 06:00:00',
                                   '2019-02-03 12:00:00',
                                   '2019-02-03 18:00:00',
                                   '2019-02-04 00:00:00',
                                   '2019-02-04 06:00:00',
                                   '2019-02-04 12:00:00',
                                   '2019-02-04 18:00:00',
                                   '2019-02-05 00:00:00',
                                   '2019-02-05 06:00:00',
                                   '2019-02-05 12:00:00',
                                   '2019-02-05 18:00:00',
                                   '2019-02-06 00:00:00',
                                   '2019-02-06 06:00:00',
                                   '2019-02-06 12:00:00',
                                   '2019-02-06 18:00:00',
                                   '2019-02-07 00:00:00',
                                   '2019-02-07 06:00:00',
                                   '2019-02-07 12:00:00',
                                   '2019-02-07 18:00:00',
                                   '2019-02-08 00:00:00',
                                   '2019-02-08 06:00:00',
                                   '2019-02-08 12:00:00',
                                   '2019-02-08 18:00:00',
                                   '2019-02-09 00:00:00',
                                   '2019-02-09 06:00:00',
                                   '2019-02-09 12:00:00',
                                   '2019-02-09 18:00:00',
                                   '2019-02-10 00:00:00',
                                   '2019-02-10 06:00:00',
                                   '2019-02-10 12:00:00',
                                   '2019-02-10 18:00:00',
                                   '2019-02-11 00:00:00',
                                   '2019-02-11 06:00:00',
                                   '2019-02-11 12:00:00',
                                   '2019-02-11 18:00:00',
                                   '2019-02-12 00:00:00',
                                   '2019-02-12 06:00:00',
                                   '2019-02-12 12:00:00',
                                   '2019-02-12 18:00:00',
                                   '2019-02-13 00:00:00',
                                   '2019-02-13 06:00:00',
                                   '2019-02-13 12:00:00',
                                   '2019-02-13 18:00:00',
                                   '2019-02-14 00:00:00',
                                   '2019-02-14 06:00:00',
                                   '2019-02-14 12:00:00',
                                   '2019-02-14 18:00:00',
                                   '2019-02-15 00:00:00',
                                   '2019-02-15 06:00:00',
                                   '2019-02-15 12:00:00',
                                   '2019-02-15 18:00:00',
                                   '2019-02-16 00:00:00',
                                   '2019-02-16 06:00:00',
                                   '2019-02-16 12:00:00',
                                   '2019-02-16 18:00:00',
                                   '2019-02-17 00:00:00',
                                   '2019-02-17 06:00:00',
                                   '2019-02-17 12:00:00',
                                   '2019-02-17 18:00:00',
                                   '2019-02-18 00:00:00',
                                   '2019-02-18 06:00:00',
                                   '2019-02-18 12:00:00',
                                   '2019-02-18 18:00:00',
                                   '2019-02-19 00:00:00',
                                   '2019-02-19 06:00:00',
                                   '2019-02-19 12:00:00',
                                   '2019-02-19 18:00:00',
                                   '2019-02-20 00:00:00',
                                   '2019-02-20 06:00:00',
                                   '2019-02-20 12:00:00',
                                   '2019-02-20 18:00:00',
                                   '2019-02-21 00:00:00',
                                   '2019-02-21 06:00:00',
                                   '2019-02-21 12:00:00',
                                   '2019-02-21 18:00:00',
                                   '2019-02-22 00:00:00',
                                   '2019-02-22 06:00:00',
                                   '2019-02-22 12:00:00',
                                   '2019-02-22 18:00:00',
                                   '2019-02-23 00:00:00',
                                   '2019-02-23 06:00:00',
                                   '2019-02-23 12:00:00',
                                   '2019-02-23 18:00:00',
                                   '2019-02-24 00:00:00',
                                   '2019-02-24 06:00:00',
                                   '2019-02-24 12:00:00',
                                   '2019-02-24 18:00:00',
                                   '2019-02-25 00:00:00',
                                   '2019-02-25 06:00:00',
                                   '2019-02-25 12:00:00',
                                   '2019-02-25 18:00:00',
                                   '2019-02-26 00:00:00',
                                   '2019-02-26 06:00:00',
                                   '2019-02-26 12:00:00',
                                   '2019-02-26 18:00:00',
                                   '2019-02-27 00:00:00',
                                   '2019-02-27 06:00:00',
                                   '2019-02-27 12:00:00',
                                   '2019-02-27 18:00:00',
                                   '2019-02-28 00:00:00',
                                   '2019-02-28 06:00:00',
                                   '2019-02-28 12:00:00',
                                   '2019-02-28 18:00:00',
                                   '2019-03-01 00:00:00',
                                   '2019-03-01 06:00:00',
                                   '2019-03-01 12:00:00',
                                   '2019-03-01 18:00:00',
                                   '2019-03-02 00:00:00',
                                   '2019-03-02 06:00:00',
                                   '2019-03-02 12:00:00',
                                   '2019-03-02 18:00:00',
                                   '2019-03-03 00:00:00',
                                   '2019-03-03 06:00:00',
                                   '2019-03-03 12:00:00',
                                   '2019-03-03 18:00:00',
                                   '2019-03-04 00:00:00',
                                   '2019-03-04 06:00:00',
                                   '2019-03-04 12:00:00',
                                   '2019-03-04 18:00:00',
                                   '2019-03-05 00:00:00',
                                   '2019-03-05 06:00:00',
                                   '2019-03-05 12:00:00',
                                   '2019-03-05 18:00:00',
                                   '2019-03-06 00:00:00',
                                   '2019-03-06 06:00:00',
                                   '2019-03-06 12:00:00',
                                   '2019-03-06 18:00:00',
                                   '2019-03-07 00:00:00',
                                   '2019-03-07 06:00:00',
                                   '2019-03-07 12:00:00',
                                   '2019-03-07 18:00:00',
                                   '2019-03-08 00:00:00',
                                   '2019-03-08 06:00:00',
                                   '2019-03-08 12:00:00',
                                   '2019-03-08 18:00:00',
                                   '2019-03-09 00:00:00',
                                   '2019-03-09 06:00:00',
                                   '2019-03-09 12:00:00',
                                   '2019-03-09 18:00:00',
                                   '2019-03-10 00:00:00')
  AND BINARY h.vx_mask IN ('G2/NHX', 'G2/SHX')
  AND BINARY ld.fcst_lead IN ('0', '6', '12', '18', '24', '30', '36', '42', '48', '54', '60', '66', '72', '78', '84', '90', '96', '102', '108', '114', '120', '126', '132', '138', '144', '150', '156', '162', '168', '174', '180', '186', '192', '198', '204', '210', '216', '222', '228', '234', '240', '252', '264', '276', '288', '300', '312', '324', '336', '348', '360', '372', '384')
  AND BINARY h.fcst_var = 'HGT'
  AND ld.stat_header_id = h.stat_header_id
ORDER BY ld.fcst_valid_beg, ld.fcst_init_beg, h.fcst_lev, ld.fcst_lead, h.vx_mask;
EOF
# get the qury time
echo $0 > "output/$0.time"
tail -3 output/$0.tmp | head -1 >> "output/$0.time"
cat output/$0.tmp | grep '|' | tr -d '|' | column -t > output/$0.tmpout
# get the header row
head -1 output/$0.tmpout | sed 's/fcst_init_beg.*fcst_valid_beg/fcst_init_beg fibT fcst_valid_beg fvbT /g' > output/$0.tmp1out 
#now the rest of the data
tail -n+2 output/$0.tmpout | awk '{printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%.10f\t%.10f\t%.10f\t%.10f\t%.10f\t%i\n", $1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15}' >> output/$0.tmp1out 
cat output/$0.tmp1out | column -t > output/$0.out 
rm output/$0.tmpout
rm output/$0.tmp1out
rm output/$0.tmp
